{% set sdk_version = "9.0.202" %}
{% set runtime_version = "9.0.3" %}
{% set framework = '.'.join(sdk_version.split('.')[:2]) %}
{% set sha256 = "e38c65156588446f4686b50607996708a4648f9075efe12d73857473f9e10136" %}  # [linux-aarch64]
{% set sha256 = "0c7bc01debcad57a61fe15bf3c7e6baff1bbbd4f10e4f1284b95866dfff5b444" %}  # [linux-64]
{% set sha256 = "4deb670a00fcbbaf65bfde9fd777a134cd34f0f1fbb94da048d303311d36ceec" %}  # [arm64]
{% set sha256 = "893930d0b256780c8f0a6c0b7a601541e39c568df835f7099fad89ab13057b31" %}  # [osx]
{% set sha256 = "d1dda520f8eb602e0b447e92d92d14145f37aa28ab59b267f6d8fc692051ec77" %}  # [win]
{% set platform = "linux-arm64" %}  # [linux-aarch64]
{% set platform = "linux-x64" %}  # [linux-64]
{% set platform = "osx-arm64" %}  # [arm64]
{% set platform = "osx-x64" %}  # [osx]
{% set platform = "win-x64" %}  # [win]
{% set ext = "tar.gz" %}  # [not win]
{% set ext = "zip" %}  # [win]

package:
  name: dotnet
  version: {{ sdk_version }}

source:
  url: https://dotnetcli.azureedge.net/dotnet/Sdk/{{ sdk_version }}/dotnet-sdk-{{ sdk_version }}-{{ platform }}.{{ ext }}
  sha256: {{ sha256 }}
  folder: dotnet

build:
  number: 3
  binary_relocation: False  # [osx]
  script_env:
    - DOTNET_RUNTIME_VERSION={{ runtime_version }}

outputs:
  - name: dotnet
    version: {{ sdk_version }}
    build:
      run_exports:
        - {{ pin_subpackage("dotnet-runtime", max_pin="x.x") }}
    requirements:
      run:
        - {{ pin_subpackage('dotnet-aspnetcore', exact=True) }}
        - {{ pin_subpackage('dotnet-desktop', exact=True) }}  # [win]
        - {{ pin_subpackage('dotnet-runtime', max_pin="x.x") }}
        - {{ pin_subpackage('dotnet-sdk', exact=True) }}
    test:
      commands:
        - dotnet --version
        # Same test without setting the environment variable that should be in activation
        - DOTNET_EnableMacOSCodeSign=true mkdir self-test && cd self-test && dotnet new console && dotnet clean && dotnet build  # [unix]
        - dotnet exec bin/Debug/net{{ framework }}/self-test.dll > self-test.txt  # [linux]
        - grep "Hello, World!" self-test.txt  # [linux]
        - mkdir self-test && cd self-test && dotnet new console && dotnet build && dotnet exec "bin/Debug/net{{ framework }}/self-test.dll" | findstr "Hello, World!"  # [win]

  - name: dotnet-runtime
    version: {{ runtime_version }}
    script: build-runtime.bat  # [win]
    script: build-runtime.sh  # [not win]
    # build:
    #   missing_dso_whitelist:
    #     - "$RPATH/ld-linux-x86-64.so.2"  # [linux and aarch64]
    #   ignore_run_exports:
    #     - libcurl  # [unix]
    #     - libcxx  # [osx]
    #     - libzlib  # [osx]
    #     # runtime attempts to load liblttng-ust.so.0 instead of liblttng-ust.so.1 that this provides
    #     # - lttng-ust  # [linux]
    requirements:
      build:
        - {{ compiler('cxx') }}
        - {{ stdlib('c') }}
        - posix  # [win]
      host:
        - libcurl  # [unix]
        # runtime attempts to load liblttng-ust.so.0 instead of liblttng-ust.so.1 that this provides
        # - lttng-ust  # [linux]
        - zlib  # [unix]
      run:
        - icu  # [unix]
        - libcurl  # [unix]
        # runtime attempts to load liblttng-ust.so.0 instead of liblttng-ust.so.1 that this provides
        # - lttng-ust  # [linux]
    test:
      commands:
        - dotnet --list-runtimes
        - test "${DOTNET_ROOT}" = "${CONDA_PREFIX}/lib/dotnet"  # [unix]
        - test "${DOTNET_TOOLS}" = "${CONDA_PREFIX}/lib/dotnet/tools"  # [unix]
        - if not defined DOTNET_ROOT exit 1  # [win]
        - if not defined DOTNET_TOOLS exit 1  # [win]
    about:
      home: https://github.com/dotnet/runtime
      license: MIT
      license_file: dotnet/LICENSE.txt
      summary: |
        .NET Core is a free and open-source managed computer software
        framework for the Windows, Linux, and macOS operating systems.

  - name: dotnet-sdk
    version: {{ sdk_version }}
    script: build-sdk.bat  # [win]
    script: build-sdk.sh  # [not win]
    build:
      run_exports:
        - {{ pin_subpackage("dotnet-runtime", max_pin="x.x") }}
    #   missing_dso_whitelist:
    #     - "$RPATH/ld-linux-x86-64.so.2"  # [linux and aarch64]
    #   ignore_run_exports:
    #     - libcurl  # [unix]
    #     - libcxx  # [osx]
    #     - libzlib  # [osx]
    #     - lttng-ust  # [linux]
    requirements:
      # build:
      #   - {{ compiler('cxx') }}
      #   - {{ stdlib('c') }}
      #   - posix  # [win]
      host:
        - dotnet-runtime ={{ runtime_version }}
      #   - libcurl  # [unix]
      #   - lttng-ust  # [linux64]
      #   - zlib  # [unix]
      run:
        - dotnet-runtime ={{ runtime_version }}
    test:
      commands:
        - dotnet --version  # [not aarch64]
        - test -f $PREFIX/lib/dotnet/dotnet  # [aarch64]
        - export DOTNET_SYSTEM_GLOBALIZATION_INVARIANT=1  # [aarch64]
        - mkdir self-test && cd self-test && dotnet new console && dotnet clean  # [unix]
        - cat self-test.csproj  # [unix]
        - DOTNET_EnableMacOSCodeSign=false dotnet build && dotnet exec bin/Debug/net{{ framework }}/self-test.dll > self-test.txt  # [unix]
        - grep "Hello, World!" self-test.txt  # [linux]
        - mkdir self-test && cd self-test && dotnet new console && dotnet build && dotnet exec "bin/Debug/net{{ framework }}/self-test.dll" | findstr "Hello, World!"  # [win]
      downstreams:
        - renode-cli
      requires:
        - icu  # [unix]
    about:
      home: https://github.com/dotnet/sdk
      license: MIT
      license_file: dotnet/LICENSE.txt
      summary: |
        .NET Core is a free and open-source managed computer software
        framework for the Windows, Linux, and macOS operating systems.

  - name: dotnet-aspnetcore
    version: {{ runtime_version }}
    script: build-aspnetcore.bat  # [win]
    script: build-aspnetcore.sh  # [not win]
    requirements:
      run:
        - dotnet-runtime ={{ runtime_version }}
    test:
      commands:
        - test -d $PREFIX/lib/dotnet/shared/Microsoft.AspNetCore.App  # [not win]
        - if not exist %PREFIX%\\dotnet\\shared\\Microsoft.AspNetCore.App exit 1  # [win]
    about:
      home: https://github.com/dotnet/aspnetcore
      license: MIT
      license_file: dotnet/LICENSE.txt
      summary: |
        .NET Core is a free and open-source managed computer software
        framework for the Windows, Linux, and macOS operating systems.

  - name: dotnet-desktop                                                              # [win]
    version: {{ runtime_version }}                                                    # [win]
    script: build-desktop.bat                                                         # [win]
    requirements:                                                                     # [win]
      build:                                                                          # [win]
        - posix                                                                       # [win]
      run:                                                                            # [win]
        - dotnet-runtime ={{ runtime_version }}                                       # [win]
    test:                                                                             # [win]
      commands:                                                                       # [win]
        - if not exist %PREFIX%\\dotnet\\shared\\Microsoft.WindowsDesktop.App exit 1  # [win]
    about:                                                                            # [win]
      home: https://github.com/dotnet/desktop                                         # [win]
      license: MIT                                                                    # [win]
      license_file: dotnet/LICENSE.txt                                                # [win]
      summary: .NET Core is a free and open-source managed computer software framework for the Windows, Linux, and macOS operating systems.  # [win]

about:
  home: https://github.com/dotnet/core
  license: MIT
  license_file: dotnet/LICENSE.txt
  summary: |
    .NET Core is a free and open-source managed computer software
    framework for the Windows, Linux, and macOS operating systems.

extra:
  recipe-maintainers:
    - dhirschfeld
    - ZimmerA
    - acesnik
